<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="polymer-openajax-datepicker">
  <template>
    <style>
       :host {
        display: block;
         --datepicker-background-color:#fff;
         --datepicker-month-color: #ddd;
         --datepicker-width:261px;
         --datepicker-zindex:1000;
         --datepicker-cells-color:#ddd;
         --datepicker-currentday-color:#FFF0C4;
         --datepicker-cellempty-color:#f9f9f9;
         --datepicker-buttons-hover:#fc3;
         --datepicker-buttons-focus:#fc3;
      }

      .datepicker {
        margin: 10px;
        padding: 2px;
        position: absolute;
        z-index: var(--datepicker-zindex);
        width: var(--datepicker-width);
        background-color: var(--datepicker-background-color);
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      div#month-wrap {
        height: 30px;
        background-color: var(--datepicker-month-color);
        border: 1px solid black;
        border-radius: 4px;
      }

      div#bn_prev {
        margin: 3px;
        float: left;
        width: 24px;
        height: 24px;
      }

      div#bn_next {
        margin: 3px;
        float: right;
        width: 24px;
        height: 24px;
      }

      div#bn_prev:hover,
      div#bn_prev:focus,
      div#bn_next:hover,
      div#bn_next:focus {
        margin: 2px;
        background-color: var(--datepicker-buttons-hover);
        border: 1px solid #800;
        border-radius: 4px;
      }

      img.bn_img {
        margin: 0;
        padding: 2px;
      }

      div#month {
        float: left;
        padding-top: 6px;
        width: 199px;
        height: 24px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2em;
      }

      table#cal {
        width: 261px;
        font-size: 1.2em;
        text-align: center;
      }

      table#cal th,
      table#cal td {
        width: 35px;
        height: 30px;
        padding: 0;
      }

      table#cal td {
        background-color: var(--datepicker-cells-color);
        border: 1px solid #999;
      }

      table#cal td.today {
        background-color: var(--datepicker-currentday-color);
        border: 1px solid #999;
      }

      table#cal td.empty {
        background-color: var(--datepicker-cellempty-color);
        border: 1px solid #eee;
      }

      table#cal td:hover,
      table#cal td.focus {
        border-color: #800;
        background-color: #fc3;
      }

      table#cal td.empty:hover {
        background-color: #f9f9f9;
        border: 1px solid #eee;
      }

      .offscreen {
        position: absolute;
        left: -200em;
        top: -100em;
      }

      [aria-hidden="true"] {
        display: none;
      }
    </style>
    <div id="dp1" class="datepicker" aria-hidden="true">
      <div id="month-wrap">
        <div id="bn_prev" role="button" aria-labelledby="bn_prev-label" tabindex="0"><img class="bn_img" src$="[[importPath]]images/prev.png" alt="" /></div>
        <div id="month" role="heading" aria-live="assertive" aria-atomic="true">February 2011</div>
        <div id="bn_next" role="button" aria-labelledby="bn_next-label" tabindex="0"><img class="bn_img" src="[[importPath]]images/next.png" alt="" /></div>
      </div>
      <table id="cal" role="grid" aria-labelledby="month" tabindex="0">
        <thead>
          <tr id="weekdays">
            <th id="Sunday"><abbr title="Sunday">Su</abbr></th>
            <th id="Monday"><abbr title="Monday">Mo</abbr></th>
            <th id="Tuesday"><abbr title="Tuesday">Tu</abbr></th>
            <th id="Wednesday"><abbr title="Wednesday">We</abbr></th>
            <th id="Thursday"><abbr title="Thursday">Th</abbr></th>
            <th id="Friday"><abbr title="Friday">Fr</abbr></th>
            <th id="Saturday"><abbr title="Saturday">Sa</abbr></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div id="bn_prev-label" class="offscreen">Go to previous month</div>
      <div id="bn_next-label" class="offscreen">Go to next month</div>
    </div>
  </template>

  <script>
    /**
     * `polymer-openajax-datepicker`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PolymerOpenajaxDatepicker extends Polymer.Element {
      static get is() { return 'polymer-openajax-datepicker'; }
      static get properties() {
        return {
          // div or text box that will receive the selected date string and focus (if modal)
          target: String,
          // true if datepicker should appear in a modal dialog box.
          bModal: Boolean,
          selectedValue: String
        };
      }
      connectedCallback() {
        super.connectedCallback();
        // element to attach widget to
        this.$id = this.shadowRoot.querySelector('#dp1');
        this.$monthObj = this.$id.querySelector('#month');
        this.$prev = this.$id.querySelector('#bn_prev');
        this.$next = this.$id.querySelector('#bn_next');
        this.$grid = this.$id.querySelector('#cal');
        // div or text box that will receive the selected date string and focus (if modal)
        this.$target = this.$id.querySelector('#' + this.target);


        this.monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'];

        this.dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        this.dateObj = new Date();

        this.curYear = this.dateObj.getFullYear();
        this.year = this.curYear;

        this.curMonth = this.dateObj.getMonth();
        this.month = this.curMonth;
        this.currentDate = true;

        this.date = this.dateObj.getDate();

        this.keys = {
          tab: 9,
          enter: 13,
          esc: 27,
          space: 32,
          pageup: 33,
          pagedown: 34,
          end: 35,
          home: 36,
          left: 37,
          up: 38,
          right: 39,
          down: 40
        };

        // display the current month
        this.$monthObj.innerHTML = this.monthNames[this.month] + ' ' + this.year;

        // populate the calendar grid
        this._popGrid();

        // update the table's activedescdendant to point to the current day
        this.$grid.setAttribute('aria-activedescendant', this.$grid.querySelector('.today').getAttribute('id'));

        this._bindHandlers();

        // hide dialog if in modal mode
        if (this.bModal === true) {
          this.$id.setAttribute('aria-hidden', 'true');
        }

        this._handlerShowDlg = function (e) {
          //ensure focus remains on the dialog
          this.$grid.focus();
          // Consume all mouse events and do nothing
          e.stopPropagation;
          return false;
        }
      }
      //
      // _popGrid() is a member function to populate the datepicker grid with calendar days
      // representing the current month
      //
      // @return N/A
      //
      _popGrid() {

        var numDays = this._calcNumDays(this.year, this.month);
        var startWeekday = this._calcStartWeekday(this.year, this.month);
        var weekday = 0;
        var curDay = 1;
        var rowCount = 1;
        var $tbody = this.$grid.querySelector('tbody');

        var gridCells = '\t<tr id="row1">\n';

        // clear the grid
        $tbody.innerHTML = '';

        // Insert the leading empty cells
        for (weekday = 0; weekday < startWeekday; weekday++) {

          gridCells += '\t\t<td class="empty">&nbsp;</td>\n';
        }

        // insert the days of the month.
        for (curDay = 1; curDay <= numDays; curDay++) {

          if (curDay === this.date && this.currentDate === true) {

            gridCells += '\t\t<td id="day' + curDay + '" class="today" headers="row' +
              rowCount + ' ' + this.dayNames[weekday] + '" role="gridcell" aria-selected="false">' + curDay + '</td>';

          }
          else {
            gridCells += '\t\t<td id="day' + curDay + '" headers="row' +
              rowCount + ' ' + this.dayNames[weekday] + '" role="gridcell" aria-selected="false">' + curDay + '</td>';
          }

          if (weekday === 6 && curDay < numDays) {
            // This was the last day of the week, close it out
            // and begin a new one
            gridCells += '\t</tr>\n\t<tr id="row' + rowCount + '">\n';
            rowCount++;
            weekday = 0;
          }
          else {
            weekday += 1;
          }
        }

        // Insert any trailing empty cells
        for (weekday; weekday < 7; weekday++) {

          gridCells += '\t\t<td class="empty">&nbsp;</td>\n';
        }

        gridCells += '\t</tr>';

        $tbody.innerHTML = gridCells;
      }

      //
      // _calcNumDays() is a member function to calculate the number of days in a given month
      //
      // @return (integer) number of days
      //
      _calcNumDays(year, month) {
        return 32 - new Date(year, month, 32).getDate();
      }

      //
      // _calcstartWeekday() is a member function to calculate the day of the week the first day of a
      // month lands on
      //
      // @return (integer) number representing the day of the week (0=Sunday....6=Saturday)
      //
      _calcStartWeekday(year, month) {
        return new Date(year, month, 1).getDay();
      }

      //
      // _showPrevMonth() is a member function to show the previous month
      //
      // @param (offset int) offset may be used to specify an offset for setting
      //                      focus on a day the specified number of days from
      //                      the end of the month.
      // @return N/A
      //
      _showPrevMonth(offset) {
        var numDays;
        var day;

        // show the previous month
        if (this.month === 0) {
          this.month = 11;
          this.year -= 1;
        }
        else {
          this.month -= 1;
        }

        if (this.month !== this.curMonth || this.year !== this.curYear) {
          this.currentDate = false;
        }
        else {
          this.currentDate = true;
        }

        // populate the calendar grid
        this._popGrid();

        this.$monthObj.innerHTML = this.monthNames[this.month] + ' ' + this.year;

        // if offset was specified, set focus on the last day - specified offset
        if (typeof offset !== 'undefined') {
          numDays = this._calcNumDays(this.year, this.month);
          day = 'day' + (numDays - offset);

          this.$grid.setAttribute('aria-activedescendant', day);
          this.$id.querySelector('#' + day).classList.add('focus');
          this.$id.querySelector('#' + day).setAttribute('aria-selected', 'true');
        }

      } // end _showPrevMonth()

      //
      // _showNextMonth() is a member function to show the next month
      //
      // @param (offset int) offset may be used to specify an offset for setting
      //                      focus on a day the specified number of days from
      //                      the beginning of the month.
      // @return N/A
      //
      _showNextMonth(offset) {
        var day;
        // show the next month
        if (this.month === 11) {
          this.month = 0;
          this.year += 1;
        }
        else {
          this.month += 1;
        }

        if (this.month !== this.curMonth || this.year !== this.curYear) {
          this.currentDate = false;
        }
        else {
          this.currentDate = true;
        }

        // populate the calendar grid
        this._popGrid();

        this.$monthObj.innerHTML = this.monthNames[this.month] + ' ' + this.year;

        // if offset was specified, set focus on the first day + specified offset
        if (typeof offset !== 'undefined') {
          day = 'day' + offset;

          this.$grid.setAttribute('aria-activedescendant', day);
          this.$grid.querySelector('#' + day).classList.add('focus');
          this.$grid.querySelector('#' + day).setAttribute('aria-selected', 'true');
        }

      }

      //
      // _showPrevYear() is a member function to show the previous year
      //
      // @return N/A
      //
      _showPrevYear() {

        // decrement the year
        this.year -= 1;

        if (this.month !== this.curMonth || this.year !== this.curYear) {
          this.currentDate = false;
        }
        else {
          this.currentDate = true;
        }

        // populate the calendar grid
        this._popGrid();

        this.$monthObj.innerHTML = this.monthNames[this.month] + ' ' + this.year;

      } // end _showPrevYear()

      //
      // _showNextYear() is a member function to show the next year
      //
      // @return N/A
      //
      _showNextYear() {

        // increment the year
        this.year += 1;

        if (this.month !== this.curMonth || this.year !== this.curYear) {
          this.currentDate = false;
        }
        else {
          this.currentDate = true;
        }

        // populate the calendar grid
        this._popGrid();

        this.$monthObj.innerHTML = this.monthNames[this.month] + ' ' + this.year;

      }

      //
      // _bindHandlers() is a member function to bind event handlers for the widget
      //
      // @return N/A
      //
      _bindHandlers() {

        ////////////////////// bind button handlers //////////////////////////////////

        this._handlePrevClick = this._handlePrevClick.bind(this);
        this._handleNextClick = this._handleNextClick.bind(this);
        this._handlePrevKeyDown = this._handlePrevKeyDown.bind(this);
        this._handleNextKeyDown = this._handleNextKeyDown.bind(this);
        this._handleGridKeyDown = this._handleGridKeyDown.bind(this);
        this._handleGridKeyPress = this._handleGridKeyPress.bind(this);
        this._handleGridFocus = this._handleGridFocus.bind(this);
        this._handleGridBlur = this._handleGridBlur.bind(this);
        this._handleGridClick = this._handleGridClick.bind(this);


        this.$prev.addEventListener('click', this._handlePrevClick);
        this.$next.addEventListener('click', this._handleNextClick);

        this.$prev.addEventListener('keydown', this._handlePrevKeyDown);
        this.$next.addEventListener('keydown', this._handleNextKeyDown);


        ///////////// bind grid handlers //////////////

        this.$grid.addEventListener('keydown', this._handleGridKeyDown);
        this.$grid.addEventListener('keypress', this._handleGridKeyPress);

        this.$grid.addEventListener('focus', this._handleGridFocus);
        this.$grid.addEventListener('blur', this._handleGridBlur);


        this.$grid.querySelector('td').addEventListener('click', this._handleGridClick);

      }

      //
      // _handlePrevClick() is a member function to process click events for the prev month button
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handlePrevClick(e) {

        var active = this.$grid.getAttribute('aria-activedescendant');

        if (e.ctrlKey) {
          this._showPrevYear();
        }
        else {
          this._showPrevMonth();
        }

        if (this.currentDate === false) {
          this.$grid.setAttribute('aria-activedescendant', 'day1');
        }
        else {
          this.$grid.setAttribute('aria-activedescendant', active);
        }

        e.stopPropagation();
        return false;

      }

      //
      // _handleNextClick() is a member function to process click events for the next month button
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handleNextClick(e) {

        var active = this.$grid.getAttribute('aria-activedescendant');

        if (e.ctrlKey) {
          this._showNextYear();
        }
        else {
          this._showNextMonth();
        }

        if (this.currentDate === false) {
          this.$grid.setAttribute('aria-activedescendant', 'day1');
        }
        else {
          this.$grid.setAttribute('aria-activedescendant', active);
        }

        e.stopPropagation();
        return false;

      }

      //
      // _handlePrevKeyDown() is a member function to process keydown events for the prev month button
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handlePrevKeyDown(e) {

        if (e.altKey) {
          return true;
        }

        switch (e.keyCode) {
          case this.keys.tab: {
            if (this.bModal === false || !e.shiftKey || e.ctrlKey) {
              return true;
            }

            this.$grid.focus();
            e.stopPropagation();
            return false;
          }
          case this.keys.enter:
          case this.keys.space: {
            if (e.shiftKey) {
              return true;
            }

            if (e.ctrlKey) {
              this._showPrevYear();
            }
            else {
              this._showPrevMonth();
            }

            e.stopPropagation();
            return false;
          }
        }

        return true;

      }

      //
      // _handleNextKeyDown() is a member function to process keydown events for the next month button
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handleNextKeyDown(e) {

        if (e.altKey) {
          return true;
        }

        switch (e.keyCode) {
          case this.keys.enter:
          case this.keys.space: {

            if (e.ctrlKey) {
              this._showNextYear();
            }
            else {
              this._showNextMonth();
            }

            e.stopPropagation();
            return false;
          }
        }

        return true;

      }

      //
      // _handleGridKeyDown() is a member function to process keydown events for the datepicker grid
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handleGridKeyDown(e) {

        var $rows = this.$grid.querySelector('tbody tr');
        var $curDay = this.$id.querySelector('#' + this.$grid.getAttribute('aria-activedescendant'));
        var $days = this.$grid.querySelectorAll('td:not(.empty)');
        var $daysArray = [].slice.call($days);
        var $curRow = $curDay.parentNode;

        if (e.altKey) {
          return true;
        }

        switch (e.keyCode) {
          case this.keys.tab: {

            if (this.bModal === true) {
              if (e.shiftKey) {
                this.$next.focus();
              }
              else {
                this.$prev.focus();
              }
              e.stopPropagation()
              return false;
            }
            break;
          }
          case this.keys.enter:
          case this.keys.space: {

            if (e.ctrlKey) {
              return true;
            }

            // update the target box
            this.selectedValue = (this.month < 9 ? '0' : '') + (this.month + 1) + '/' + $curDay.innerHTML + '/' + this.year;

            // fall through
          }
          case this.keys.esc: {
            // dismiss the dialog box
            this._hideDlg();

            e.stopPropagation();
            return false;
          }
          case this.keys.left: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            var dayIndex = $daysArray.indexOf($curDay) - 1;
            var $prevDay = null;

            if (dayIndex >= 0) {
              $prevDay = $days[dayIndex];

              $curDay.classList.remove('focus');
              $curDay.setAttribute('aria-selected', 'false');
              $prevDay.classList.add('focus')
              $prevDay.setAttribute('aria-selected', 'true');

              this.$grid.setAttribute('aria-activedescendant', $prevDay.getAttribute('id'));
            }
            else {
              this._showPrevMonth(0);
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.right: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            var dayIndex = $daysArray.indexOf($curDay) + 1;
            var $nextDay = null;

            if (dayIndex < $days.length) {
              $nextDay = $days[dayIndex];
              $curDay.classList.remove('focus');
              $curDay.setAttribute('aria-selected', 'false');
              $nextDay.classList.add('focus');
              $nextDay.setAttribute('aria-selected', 'true');

              this.$grid.setAttribute('aria-activedescendant', $nextDay.getAttribute('id'));
            }
            else {
              // move to the next month
              this._showNextMonth(1);
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.up: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            var dayIndex = $daysArray.indexOf($curDay) - 7;
            var $prevDay = null;

            if (dayIndex >= 0) {
              $prevDay = $days[dayIndex];

              $curDay.classList.remove('focus');
              $curDay.setAttribute('aria-selected', 'false');
              $prevDay.classList.add('focus');
              $prevDay.setAttribute('aria-selected', 'true');

              this.$grid.setAttribute('aria-activedescendant', $prevDay.getAttribute('id'));
            }
            else {
              // move to appropriate day in previous month
              dayIndex = 6 - $daysArray.indexOf($curDay);

              this._showPrevMonth(dayIndex);
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.down: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            var dayIndex = $daysArray.indexOf($curDay) + 7;
            var $prevDay = null;

            if (dayIndex < $days.length) {
              $prevDay = $days[dayIndex];

              $curDay.classList.remove('focus');
              $curDay.setAttribute('aria-selected', 'false');
              $prevDay.classList.add('focus');
              $prevDay.setAttribute('aria-selected', 'true');

              this.$grid.setAttribute('aria-activedescendant', $prevDay.getAttribute('id'));
            }
            else {
              // move to appropriate day in next month
              dayIndex = 8 - ($days.length - $daysArray.indexOf($curDay));

              this._showNextMonth(dayIndex);
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.pageup: {
            var active = this.$grid.getAttribute('aria-activedescendant');


            if (e.shiftKey) {
              return true;
            }


            if (e.ctrlKey) {
              this._showPrevYear();
            }
            else {
              this._showPrevMonth();
            }

            if (typeof this.$id.querySelector('#' + active).setAttribute('id') === 'undefined') {
              var lastDay = 'day' + this._calcNumDays(this.year, this.month);
              this.$id.querySelector('#' + lastDay).classList.add('focus');
              this.$id.querySelector('#' + lastDay).setAttribute('aria-selected', 'true');
            }
            else {
              this.$id.querySelector('#' + active).classList.add('focus');
              this.$id.querySelector('#' + active).setAttribute('aria-selected', 'true');
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.pagedown: {
            var active = this.$grid.getAttribute('aria-activedescendant');


            if (e.shiftKey) {
              return true;
            }

            if (e.ctrlKey) {
              this._showNextYear();
            }
            else {
              this._showNextMonth();
            }

            if ($('#' + active).setAttribute('id') == undefined) {
              var lastDay = 'day' + this._calcNumDays(this.year, this.month);
              this.$id.querySelector('#' + lastDay).classList.add('focus');
              this.$id.querySelector('#' + lastDay).setAttribute('aria-selected', 'true');
            }
            else {
              this.$id.querySelector('#' + active).classList.add('focus');
              this.$id.querySelector('#' + active).setAttribute('aria-selected', 'true');
            }

            e.stopPropagation();
            return false;
          }
          case this.keys.home: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            $curDay.classList.remove('focus');
            $curDay.setAttribute('aria-selected', 'false');

            this.$id.querySelector('#day1').classList.add('focus')
            this.$id.querySelector('#day1').setAttribute('aria-selected', 'true');

            this.$grid.setAttribute('aria-activedescendant', 'day1');

            e.stopPropagation();
            return false;
          }
          case this.keys.end: {

            if (e.ctrlKey || e.shiftKey) {
              return true;
            }

            var lastDay = 'day' + this._calcNumDays(this.year, this.month);

            $curDay.classList.remove('focus')
            $curDay.setAttribute('aria-selected', 'false');

            this.$id.querySelector('#' + lastDay).classList.add('focus');
            this.$id.querySelector('#' + lastDay).setAttribute('aria-selected', 'true');

            this.$grid.setAttribute('aria-activedescendant', lastDay);

            e.stopPropagation();
            return false;
          }
        }

        return true;

      }

      //
      // _handleGridKeyPress() is a member function to consume keypress events for browsers that
      // use keypress to scroll the screen and manipulate tabs
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handleGridKeyPress(e) {

        if (e.altKey) {
          return true;
        }

        switch (e.keyCode) {
          case this.keys.tab:
          case this.keys.enter:
          case this.keys.space:
          case this.keys.esc:
          case this.keys.left:
          case this.keys.right:
          case this.keys.up:
          case this.keys.down:
          case this.keys.pageup:
          case this.keys.pagedown:
          case this.keys.home:
          case this.keys.end: {
            e.stopPropagation();
            return false;
          }
        }

        return true;

      }

      _is(el, selector) {
        return (el.matches || el.matchesSelector || el.msMatchesSelector || el.mozMatchesSelector || el.webkitMatchesSelector || el.oMatchesSelector).call(el, selector);
      }

      //
      // _handleGridClick() is a member function to process mouse click events for the datepicker grid
      //
      // @input (id obj) e is the id of the object triggering the event
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) false if consuming event, true if propagating
      //
      _handleGridClick(id, e) {
        var $cell = this.$.$id.querySelector(id);
        if (this._is($cell, '.empty')) {
          return true;
        }

        this.$grid.querySelector('.focus').classList.remove('focus');
        this.$grid.setAttribute('aria-selected', 'false');
        $cell.classList.add('focus');
        $cell.setAttribute('aria-selected', 'true');
        this.$grid.setAttribute('aria-activedescendant', $cell.getAttribute('id'));

        var $curDay = this.$id.querySelector('#' + this.$grid.getAttribute('aria-activedescendant'));

        // update the target box
        this.$target.value = (this.month < 9 ? '0' : '') + (this.month + 1) + '/' + $curDay.html() + '/' + this.year;

        // dismiss the dialog box
        this._hideDlg();

        e.stopPropagation();
        return false;

      }

      //
      // _handleGridFocus() is a member function to process focus events for the datepicker grid
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) true
      //
      _handleGridFocus(e) {
        var active = this.$grid.getAttribute('aria-activedescendant');

        if (typeof this.$grid.querySelector('#' + active).getAttribute('id') === 'undefined') {
          var lastDay = 'day' + this._calcNumDays(this.year, this.month);
          this.$grid.querySelector('#' + lastDay).classList.add('focus')
          this.$grid.querySelector('#' + lastDay).setAttribute('aria-selected', 'true');
        }
        else {
          this.$grid.querySelector('#' + active).classList.add('focus')
          this.$grid.querySelector('#' + active).setAttribute('aria-selected', 'true');
        }

        return true;

      }

      //
      // _handleGridBlur() is a member function to process blur events for the datepicker grid
      //
      // @input (e obj) e is the event object associated with the event
      //
      // @return (boolean) true
      //
      _handleGridBlur(e) {
        this.$id.querySelector('#' + this.$grid.getAttribute('aria-activedescendant')).classList.remove('focus');
        this.$id.querySelector('#' + this.$grid.getAttribute('aria-activedescendant')).setAttribute('aria-selected', 'false');
        return true;

      }

      //
      // showDlg() is a member function to show the datepicker and give it focus. This function is only called if
      // the datepicker is used in modal dialog mode.
      //
      // @return N/A
      //
      showDlg() {

        // Bind an event listener to the document to capture all mouse events to make dialog modal
        document.addEventListener('click', () => this._handlerShowDlg);
        document.addEventListener('mousedown', () => this._handlerShowDlg);
        document.addEventListener('mouseup', () => this._handlerShowDlg);
        document.addEventListener('mousemove', () => this._handlerShowDlg);
        document.addEventListener('mouseover', () => this._handlerShowDlg);

        // show the dialog
        this.$id.setAttribute('aria-hidden', 'false');

        this.$grid.focus();

      } // end showDlg()

      //
      // _hideDlg() is a member function to hide the datepicker and remove focus. This function is only called if
      // the datepicker is used in modal dialog mode.
      //
      // @return N/A
      //
      _hideDlg() {

        // unbind the modal event sinks
        document.removeEventListener('click', this._handlerShowDlg);
        document.removeEventListener('mousedown', this._handlerShowDlg);
        document.removeEventListener('mouseup', this._handlerShowDlg);
        document.removeEventListener('mousemove', this._handlerShowDlg);
        document.removeEventListener('mouseover', this._handlerShowDlg);

        // hide the dialog
        this.$id.setAttribute('aria-hidden', 'true');

        // set focus on the focus target
        //this.$target.focus();

      }
    }

    window.customElements.define(PolymerOpenajaxDatepicker.is, PolymerOpenajaxDatepicker);
  </script>
</dom-module>